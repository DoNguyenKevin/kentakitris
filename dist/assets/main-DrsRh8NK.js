import"./index-DSrVgnXV.js";import{initializeApp as Me}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import{getAuth as Re,onAuthStateChanged as _e,signInAnonymously as fe}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import{getDatabase as Oe}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";const Ne={apiKey:"AIzaSyB20BwcVcwBBLQc8p-hPH6v2dd1Ag8uvgk",authDomain:"kentakitris.firebaseapp.com",databaseURL:"https://kentakitris-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"kentakitris",storageBucket:"kentakitris.firebasestorage.app",messagingSenderId:"813070706725",appId:"1:813070706725:web:50bdddc7bdfa897ab877cc",measurementId:"G-DMJSY5GMQS"},he=Me(Ne),De=Oe(he),$=Re(he);let Y=null,$e=localStorage.getItem("playerName")||null;window.db=De;window.auth=$;_e($,async e=>{if(e){Y=e.uid,window.userId=Y;const t=Y.substring(0,8),n=$e||t;document.getElementById("user-id-display").textContent=`Player: ${n}`,window.loadLeaderboard&&window.loadLeaderboard()}else try{await fe($)}catch(t){console.error("Anonymous sign-in failed:",t),document.getElementById("user-id-display").textContent="Auth failed"}});fe($).catch(e=>{console.error("Initial sign-in failed:",e)});const He="modulepreload",Ge=function(e){return"/"+e},se={},pe=function(t,n,s){let o=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),i=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));o=Promise.allSettled(n.map(l=>{if(l=Ge(l),l in se)return;se[l]=!0;const d=l.endsWith(".css"),b=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${b}`))return;const y=document.createElement("link");if(y.rel=d?"stylesheet":He,d||(y.as="script"),y.crossOrigin="",y.href=l,i&&y.setAttribute("nonce",i),document.head.appendChild(y),d)return new Promise((C,Te)=>{y.addEventListener("load",C),y.addEventListener("error",()=>Te(new Error(`Unable to preload CSS for ${l}`)))})}))}function a(r){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=r,window.dispatchEvent(i),!i.defaultPrevented)throw r}return o.then(r=>{for(const i of r||[])i.status==="rejected"&&a(i.reason);return t().catch(a)})};function Ee(){return new Date().toISOString().split("T")[0]}function ye(){const e=localStorage.getItem("lastNameChangeDate"),t=Ee();return e!==t}function We(e){localStorage.setItem("playerName",e),localStorage.setItem("lastNameChangeDate",Ee())}function ge(){return localStorage.getItem("playerName")||null}const h=10,g=20,k=4,Ue=10,Ve=10,Ye=1e3,be={CLEAR_BOTTOM:{id:"CLEAR_BOTTOM",name:"🔥 Clear Bottom",description:"Instantly clear the bottom 2 rows",icon:"🔥",rarity:"common",color:"orange",type:"instant"},BOMB:{id:"BOMB",name:"💣 Bomb",description:"Clear a 3x3 area around next placed piece",icon:"💣",rarity:"uncommon",color:"red",type:"nextPiece",duration:1},LASER:{id:"LASER",name:"⚡ Laser Beam",description:"Clear an entire column",icon:"⚡",rarity:"rare",color:"yellow",type:"instant"},SLOW_TIME:{id:"SLOW_TIME",name:"⏰ Slow Time",description:"Reduce falling speed by 50% for 30 seconds",icon:"⏰",rarity:"uncommon",color:"blue",type:"duration",duration:3e4},GHOST_PIECE:{id:"GHOST_PIECE",name:"👻 Ghost Mode",description:"See where piece will land (permanent)",icon:"👻",rarity:"rare",color:"cyan",type:"permanent"},SHIELD:{id:"SHIELD",name:"🛡️ Shield",description:"Prevent game over once",icon:"🛡️",rarity:"legendary",color:"gold",type:"passive"},SCORE_BOOST:{id:"SCORE_BOOST",name:"💰 Score Boost",description:"+50% score for 20 seconds",icon:"💰",rarity:"common",color:"green",type:"duration",duration:2e4},SWAP_PIECE:{id:"SWAP_PIECE",name:"🔄 Swap Hold",description:"Hold and swap current piece (permanent)",icon:"🔄",rarity:"rare",color:"purple",type:"permanent"},PREVIEW_PLUS:{id:"PREVIEW_PLUS",name:"🔮 Preview+",description:"See next 3 pieces instead of 1",icon:"🔮",rarity:"uncommon",color:"purple",type:"permanent"},TELEPORT:{id:"TELEPORT",name:"🌀 Teleport",description:"Move current piece anywhere on board",icon:"🌀",rarity:"rare",color:"magenta",type:"instant"},REVERSE_GRAVITY:{id:"REVERSE_GRAVITY",name:"🔺 Reverse Gravity",description:"Pieces rise up for 15 seconds",icon:"🔺",rarity:"legendary",color:"pink",type:"duration",duration:15e3},RANDOM_CLEAR:{id:"RANDOM_CLEAR",name:"🎲 Random Clear",description:"Clear 5-10 random blocks",icon:"🎲",rarity:"common",color:"rainbow",type:"instant"},MAGIC_BLOCK:{id:"MAGIC_BLOCK",name:"✨ Magic Block",description:"Next piece fills gaps automatically",icon:"✨",rarity:"uncommon",color:"gold",type:"nextPiece",duration:1},WIDE_PIECE:{id:"WIDE_PIECE",name:"📏 Wide Mode",description:"Board becomes 12 blocks wide for 25s",icon:"📏",rarity:"legendary",color:"blue",type:"duration",duration:25e3},TIME_FREEZE:{id:"TIME_FREEZE",name:"❄️ Time Freeze",description:"Pause piece falling for 10 seconds",icon:"❄️",rarity:"rare",color:"cyan",type:"duration",duration:1e4}},Fe={common:50,uncommon:30,rare:15,legendary:5},ie=[[[0,1,0],[1,1,1],[0,0,0]],[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[1,0,0],[1,1,1],[0,0,0]],[[0,0,1],[1,1,1],[0,0,0]],[[1,1],[1,1]],[[0,1,1],[1,1,0],[0,0,0]],[[1,1,0],[0,1,1],[0,0,0]]],H=[null,"color-1","color-2","color-3","color-4","color-5","color-6","color-7"];let u=[],c=null,w=null,A=0,X=0,x=1,f=!1,p=!1,E=null,I=[],B=[],D={},O=null,T=!1,ce=[];const L=document.getElementById("game-board"),ze=document.getElementById("score-display"),Xe=document.getElementById("level-display"),F=document.getElementById("next-piece-display"),P=document.getElementById("status-message"),G=document.getElementById("start-button"),M=document.getElementById("pause-button"),we=document.getElementById("touch-controls"),N=document.getElementById("leaderboard-list"),W=document.getElementById("name-modal"),ve=document.getElementById("modal-score"),j=document.getElementById("player-name-input"),le=document.getElementById("name-input-section"),de=document.getElementById("name-locked-section"),je=document.getElementById("current-player-name"),z=document.getElementById("save-score-btn"),Ze=document.getElementById("skip-save-btn"),m=document.getElementById("save-status"),Ie=document.getElementById("powerup-modal"),ue=document.getElementById("powerup-choices"),me=document.getElementById("active-powerups-display"),U=document.getElementById("settings-modal"),qe=document.getElementById("settings-button"),Ke=document.getElementById("settings-close-btn"),K=document.getElementById("show-speed-toggle");window.saveScore=async e=>{if(!window.db||!window.userId)return console.log("Cannot save score: Firebase or User ID not initialized."),m.textContent="❌ Firebase not initialized",m.className="text-sm text-center mt-4 text-red-400",!1;const{ref:t,set:n,get:s}=await pe(async()=>{const{ref:r,set:i,get:l}=await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js");return{ref:r,set:i,get:l}},[]),o=ge()||window.userId.substring(0,8),a=t(window.db,`leaderboards/global/${window.userId}`);try{const i=(await s(a)).val();return!i||e>i.score?(await n(a,{name:o,score:e,updatedAt:Date.now()}),console.log(`Score saved: ${e} (Previous: ${(i==null?void 0:i.score)||0})`),m.textContent=i?`🎉 New High Score! ${e} (Previous: ${i.score})`:`✅ Score saved: ${e}`,m.className="text-sm text-center mt-4 text-green-400",!0):(console.log(`Score ${e} not saved. Current best: ${i.score}`),m.textContent=`⚠️ Your best score is still ${i.score}`,m.className="text-sm text-center mt-4 text-yellow-400",!1)}catch(r){return console.error("Error saving score to Realtime Database:",r),m.textContent=`❌ Error: ${r.message}`,m.className="text-sm text-center mt-4 text-red-400",!1}};window.loadLeaderboard=()=>{if(!window.db)return;const{ref:e,query:t,orderByChild:n,limitToLast:s,onValue:o}=window.loadLeaderboard.imports||{};if(!window.loadLeaderboard.imports){pe(()=>import("https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js"),[]).then(i=>{window.loadLeaderboard.imports=i,window.loadLeaderboard()});return}const a=e(window.db,"leaderboards/global"),r=t(a,n("score"),s(10));o(r,i=>{const l=[];if(i.forEach(d=>{const b=d.val();l.push({uid:d.key,name:b.name,score:b.score,updatedAt:b.updatedAt})}),l.sort((d,b)=>b.score-d.score),N.innerHTML="",l.length===0){N.innerHTML='<p class="text-gray-400">No scores yet! Be the first!</p>';return}l.forEach((d,b)=>{const y=d.uid===window.userId,C=document.createElement("li");C.className=`flex justify-between ${y?"text-yellow-300 font-bold":"text-white"}`,C.innerHTML=`
                <span class="w-1/12">${b+1}.</span>
                <span class="w-7/12 truncate">${d.name}</span>
                <span class="w-4/12 text-right">${d.score}</span>
            `,N.appendChild(C)})},i=>{console.error("Error listening to leaderboard:",i),N.innerHTML='<p class="text-red-400 text-sm">Error loading leaderboard.</p>'})};function Qe(e=3){const t=Object.values(be),n=[],s=[];for(t.forEach(o=>{const a=Fe[o.rarity];for(let r=0;r<a;r++)s.push(o)});n.length<e&&s.length>0;){const o=Math.floor(Math.random()*s.length),a=s[o];n.find(r=>r.id===a.id)||n.push(a),s.splice(0,s.length,...s.filter(r=>r.id!==a.id))}return n}function Je(){f&&!p&&(p=!0,clearInterval(E),E=null);const e=Qe(3);ue.innerHTML="",e.forEach(t=>{const n=et(t);ue.appendChild(n)}),Q(),Ie.classList.remove("hidden")}function et(e){const t=document.createElement("div"),n={common:"border-green-500 bg-green-900/20",uncommon:"border-blue-500 bg-blue-900/20",rare:"border-purple-500 bg-purple-900/20",legendary:"border-yellow-500 bg-yellow-900/20 animate-pulse"};return t.className=`powerup-card border-4 ${n[e.rarity]} p-4 rounded-lg cursor-pointer hover:scale-105 transition-transform`,t.innerHTML=`
        <div class="text-center">
            <div class="text-6xl mb-3">${e.icon}</div>
            <h3 class="text-lg font-bold text-white mb-2">${e.name.replace(e.icon,"").trim()}</h3>
            <p class="text-sm text-gray-300 mb-3 min-h-[3rem]">${e.description}</p>
            <div class="text-xs text-${e.color}-400 uppercase font-bold mb-3">${e.rarity}</div>
            <button class="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white font-bold py-2 px-4 rounded">
                SELECT
            </button>
        </div>
    `,t.querySelector("button").addEventListener("click",()=>{nt(e),tt()}),t}function tt(){Ie.classList.add("hidden"),f&&(p=!1,_())}function nt(e){switch(console.log(`Activating powerup: ${e.name}`),P.textContent=`${e.icon} ${e.name} Activated!`,setTimeout(()=>{f&&(P.textContent="GAME ON!")},2e3),e.type){case"instant":ot(e);break;case"duration":rt(e);break;case"permanent":at(e);break;case"passive":st(e);break;case"nextPiece":it(e);break}Q()}function ot(e){switch(e.id){case"CLEAR_BOTTOM":u.splice(g-2,2),u.unshift(Array(h).fill(0),Array(h).fill(0)),v();break;case"LASER":let t=0,n=g;for(let o=0;o<h;o++)for(let a=0;a<g;a++)u[a][o]!==0&&a<n&&(n=a,t=o);for(let o=0;o<g;o++)u[o][t]=0;v();break;case"RANDOM_CLEAR":const s=Math.floor(Math.random()*6)+5;for(let o=0;o<s;o++){const a=Math.floor(Math.random()*g),r=Math.floor(Math.random()*h);u[a][r]=0}v();break}}function rt(e){const t=Date.now()+e.duration;switch(I.push({...e,endTime:t}),e.id){case"SLOW_TIME":ne();break;case"SCORE_BOOST":break;case"TIME_FREEZE":clearInterval(E),E=null;break}D[e.id]=setTimeout(()=>{Z(e.id)},e.duration)}function at(e){switch(B.includes(e.id)||B.push(e.id),e.id){case"GHOST_PIECE":v();break;case"SWAP_PIECE":break;case"PREVIEW_PLUS":ce.length===0&&(ce=[w,R(),R()]);break}}function st(e){switch(e.id){case"SHIELD":T=!0;break}}function it(e){I.find(t=>t.id===e.id)||I.push({...e,uses:1})}function Z(e){switch(I=I.filter(t=>t.id!==e),D[e]&&(clearTimeout(D[e]),delete D[e]),e){case"SLOW_TIME":ne();break;case"SCORE_BOOST":break;case"TIME_FREEZE":f&&!p&&_();break}Q()}function Q(){const e=[...I,...B.map(t=>({id:t,permanent:!0}))];if(T&&e.push({id:"SHIELD",icon:"🛡️"}),e.length===0)me.textContent="Active: None";else{const t=e.map(n=>{const s=be[n.id];if(!s)return"";let o=s.icon;if(n.endTime){const a=Math.ceil((n.endTime-Date.now())/1e3);o+=` (${a}s)`}else n.permanent?o+=" (∞)":n.uses&&(o+=` (${n.uses}×)`);return o}).filter(Boolean);me.textContent=`Active: ${t.join(", ")}`}}function J(e){return I.some(t=>t.id===e)||B.includes(e)||e==="SHIELD"&&T}function Se(){let e=Ye/x;return J("SLOW_TIME")&&(e*=2),e}function ct(){if(!J("SWAP_PIECE"))return;const e={shape:c.shape,color:c.color,rotation:c.rotation};O?(c.shape=O.shape,c.color=O.color,c.rotation=0,c.x=Math.floor((h-c.shape[0][0].length)/2),c.y=0):spawnNewPiece(),O={shape:e.shape,color:e.color},render()}function Le(){u=Array.from({length:g},()=>Array(h).fill(0))}function R(){const e=Math.floor(Math.random()*ie.length),t=ie[e],n=e+1,s=Math.floor(h/2)-Math.floor(t[0].length/2);return{shape:t,color:n,x:s,y:0}}function v(){L.innerHTML="",u.forEach((e,t)=>{e.forEach((n,s)=>{const o=document.createElement("div");o.classList.add("block"),n!==0&&o.classList.add(H[n]),t<2&&(o.style.visibility="hidden"),L.appendChild(o)})}),c&&lt(c)}function lt(e){e.shape.forEach((t,n)=>{t.forEach((s,o)=>{if(s){const a=e.x+o,r=e.y+n;if(r>=0&&r<g&&a>=0&&a<h){const i=r*h+a,l=L.children[i];l&&(l.classList.remove(...H),l.classList.add(H[e.color],"current-piece-cell"),l.style.visibility="visible")}}})})}function ee(){F.innerHTML="";for(let e=0;e<k*k;e++){const t=document.createElement("div");t.classList.add("block","w-1/4","h-1/4","border-gray-800"),F.appendChild(t)}if(w){const e=Math.floor((k-w.shape.length)/2),t=Math.floor((k-w.shape[0].length)/2);w.shape.forEach((n,s)=>{n.forEach((o,a)=>{if(o){const r=t+a,l=(e+s)*k+r,d=F.children[l];d&&d.classList.add(H[w.color])}})})}}function te(e){for(let t=0;t<e.shape.length;t++)for(let n=0;n<e.shape[t].length;n++)if(e.shape[t][n]){const s=e.x+n,o=e.y+t;if(s<0||s>=h||o>=g||o>=0&&o<g&&u[o][s]!==0)return!0}return!1}function dt(){c.shape.forEach((e,t)=>{e.forEach((n,s)=>{if(n){const o=c.x+s,a=c.y+t;a>=0&&(u[a][o]=c.color)}})})}function ut(){let e=0;for(let t=g-1;t>=0;t--)if(u[t].every(n=>n!==0)){e++;for(let n=t;n>0;n--)u[n]=u[n-1];u[0]=Array(h).fill(0),t++}if(e>0){A+=[0,1,3,5,8][e]*Ue*x,X+=e;const n=Math.floor(X/Ve)+1;n>x&&(x=n,Je(),ne()),V()}}function S(e,t){if(!c)return;const n={...c,x:c.x+e,y:c.y+t};return te(n)?!1:(c=n,v(),!0)}function Pe(){if(!c)return;let e=0;for(;S(0,1);)e++;e>0&&Ce(!0)}function xe(){if(!c)return;const e=c.shape,t=e.length,n=Array.from({length:t},()=>Array(t).fill(0));for(let a=0;a<t;a++)for(let r=0;r<t;r++)n[r][t-1-a]=e[a][r];const s={...c,shape:n},o=[[0,0],[-1,0],[1,0],[0,-1],[0,1]];for(const[a,r]of o){const i={...s,x:s.x+a,y:s.y+r};if(!te(i)){c=i,v();return}}}function Ce(e=!1){if(!f||p)return;if(!S(0,1)||e){if(dt(),ut(),c=w,w=R(),ee(),te(c)){mt();return}v()}}function V(){ze.textContent=A,Xe.textContent=x;const e=document.getElementById("speed-display");if(e)if(localStorage.getItem("showSpeed")==="true"){const n=Math.round(Se());e.textContent=`(${n}ms)`,e.classList.remove("hidden")}else e.classList.add("hidden")}function _(){const e=Se();E&&clearInterval(E),E=setInterval(Ce,e)}function ne(){f&&!p&&_()}function ke(){f||(Le(),A=0,X=0,x=1,V(),c=R(),w=R(),ee(),f=!0,p=!1,P.textContent="GAME ON!",G.classList.add("hidden"),M.classList.remove("hidden"),v(),_(),pt())}function q(){f&&(p=!p,p?(clearInterval(E),E=null,P.textContent="PAUSED",M.textContent="RESUME"):(_(),P.textContent="GAME ON!",M.textContent="PAUSE"))}function mt(){if(T){T=!1,Z("SHIELD"),P.textContent="🛡️ SHIELD SAVED YOU!";for(let e=0;e<4;e++)u[e]=Array(h).fill(0);render(),L.style.opacity="0.3",setTimeout(()=>{L.style.opacity="1"},200);return}f=!1,E&&clearInterval(E),E=null,I.forEach(e=>Z(e.id)),I=[],B=[],P.textContent=`GAME OVER! Score: ${A}`,G.textContent="RESTART",G.classList.remove("hidden"),M.classList.add("hidden"),L.style.opacity="0.5",setTimeout(()=>{L.style.opacity="1"},100),ft(A),document.removeEventListener("keydown",ae),we.removeEventListener("click",Be)}function ft(e){ve.textContent=e,m.textContent="";const t=ge();ye()?(le.classList.remove("hidden"),de.classList.add("hidden"),j.value=t||"",j.disabled=!1):(le.classList.add("hidden"),de.classList.remove("hidden"),je.textContent=t||"Anonymous"),W.classList.remove("hidden")}function oe(){W.classList.add("hidden")}function ht(){const e=localStorage.getItem("showSpeed")==="true";K.checked=e,U.classList.remove("hidden")}function Ae(){U.classList.add("hidden")}function re(){const e=K.checked;localStorage.setItem("showSpeed",e.toString()),V()}function ae(e){if(!f||p){e.key===" "&&!f?ke():(e.key==="p"||e.key==="P")&&q();return}switch(e.key){case"ArrowLeft":S(-1,0);break;case"ArrowRight":S(1,0);break;case"ArrowDown":S(0,1);break;case"ArrowUp":case"x":xe();break;case" ":Pe(),e.preventDefault();break;case"h":case"H":J("SWAP_PIECE")&&ct();break;case"p":case"P":q();break}}function Be(e){var n;const t=(n=e.target.closest("button"))==null?void 0:n.dataset.action;if(!(!t||!f||p))switch(t){case"left":S(-1,0);break;case"right":S(1,0);break;case"down":S(0,1);break;case"rotate":xe();break;case"hard-drop":Pe();break}}function pt(){document.addEventListener("keydown",ae),we.addEventListener("click",Be)}G.addEventListener("click",ke);M.addEventListener("click",q);z.addEventListener("click",async()=>{if(ye()){const n=j.value.trim();if(n&&n.length>0&&n.length<=20){We(n),console.log(`Player name saved: ${n}`);const s=n;document.getElementById("user-id-display").textContent=`Player: ${s}`}else if(n.length>20){m.textContent="❌ Name too long (max 20 characters)",m.className="text-sm text-center mt-4 text-red-400";return}}z.disabled=!0,m.textContent="⏳ Saving...",m.className="text-sm text-center mt-4 text-yellow-400";const e=parseInt(ve.textContent),t=await window.saveScore(e);z.disabled=!1,t&&setTimeout(()=>{oe()},2e3)});Ze.addEventListener("click",()=>{oe()});W.addEventListener("click",e=>{e.target===W&&oe()});qe.addEventListener("click",()=>{ht()});Ke.addEventListener("click",()=>{re(),Ae()});K.addEventListener("change",()=>{re()});U.addEventListener("click",e=>{e.target===U&&(re(),Ae())});Le();v();ee();V();document.addEventListener("keydown",ae);
