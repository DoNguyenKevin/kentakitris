import"./index-DSrVgnXV.js";import{initializeApp as Ee}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import{getAuth as be,onAuthStateChanged as Ie,signInAnonymously as _,signInWithCustomToken as we}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import{setLogLevel as Le,getFirestore as ke,query as oe,collection as se,orderBy as xe,limit as ae,onSnapshot as ve,doc as Pe,where as Se,getDocs as Be,updateDoc as Ce,setDoc as De}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";Le("Debug");const Me=typeof __app_id<"u"?__app_id:"default-app-id",Z=JSON.parse(typeof __firebase_config<"u"?__firebase_config:"{}"),Q=typeof __initial_auth_token<"u"?__initial_auth_token:null;let T,R,h,d=null;async function Ae(){return new Promise(e=>{Object.keys(Z).length>0?(T=Ee(Z),R=ke(T),h=be(T),window.db=R,window.auth=h,Ie(h,async n=>{if(n)d=n.uid,console.log("User authenticated:",d);else{console.log("No user authenticated, attempting anonymous sign-in...");try{d=(await _(h)).user.uid,console.log("Anonymous sign-in successful:",d)}catch(t){console.error("Anonymous sign-in failed:",t)}}window.userId=d,document.getElementById("user-id-display").textContent=d?`Player ID: ${d}`:"Authenticating...",e({db:R,auth:h,userId:d,appId:Me})}),Q?we(h,Q).catch(n=>{console.error("Custom token sign-in failed:",n),_(h)}):_(h)):(console.warn("Firebase configuration is missing. Leaderboard functionality is disabled."),document.getElementById("leaderboard-container").innerHTML='<p class="text-red-400 text-sm">Leaderboard disabled (Missing Firebase config).</p>',window.db=null,window.auth=null,d=crypto.randomUUID(),window.userId=d,document.getElementById("user-id-display").textContent=`Mock ID: ${d}`,e({db:null,auth:null,userId:d,appId:"local"}))})}const re="leaderboard",C=document.getElementById("leaderboard-list");let U,w,I;function _e(e,n,t){U=e,w=n,I=t}async function Te(e){if(!w||!I){console.log("Cannot save score: Firebase or User ID not initialized.");return}const n=I.substring(0,8),t=crypto.randomUUID(),s=`/artifacts/${U}/public/data/${re}`,o=Pe(w,s,t);try{const a=oe(se(w,s),Se("userId","==",I),ae(1)),r=await Be(a);if(r.empty)await De(o,{userId:I,username:n,score:e,timestamp:Date.now()}),console.log("Score saved to Firestore:",e);else{const c=r.docs[0],i=c.data().score;e>i?(await Ce(c.ref,{score:e,timestamp:Date.now()}),console.log("High score updated:",e)):console.log("Score not higher than existing high score.")}}catch(a){console.error("Error saving score to Firestore:",a)}}function Re(){if(!w)return;const e=`/artifacts/${U}/public/data/${re}`,n=oe(se(w,e),xe("score","desc"),ae(10));ve(n,t=>{if(C.innerHTML="",t.empty){C.innerHTML='<p class="text-gray-400 text-sm">No scores yet. Be the first!</p>';return}t.docs.forEach((s,o)=>{const a=s.data(),r=document.createElement("div");r.className="flex justify-between items-center text-sm py-1 px-2 rounded",a.userId===I&&r.classList.add("bg-yellow-900","bg-opacity-30"),r.innerHTML=`
                <span class="text-gray-400">#${o+1}</span>
                <span class="text-white truncate mx-2 flex-1">${a.username||"Anonymous"}</span>
                <span class="text-yellow-400 font-bold">${a.score}</span>
            `,C.appendChild(r)})},t=>{console.error("Error listening to leaderboard:",t),C.innerHTML='<p class="text-red-400 text-sm">Error loading leaderboard.</p>'})}const f=10,P=20,v=4,$e=10,Ne=10,ce=1e3,ee=[[[0,1,0],[1,1,1],[0,0,0]],[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[1,0,0],[1,1,1],[0,0,0]],[[0,0,1],[1,1,1],[0,0,0]],[[1,1],[1,1]],[[0,1,1],[1,1,0],[0,0,0]],[[1,1,0],[0,1,1],[0,0,0]]],G=[null,"color-1","color-2","color-3","color-4","color-5","color-6","color-7"];let u=[],l=null,m=null,L=0,F=0,B=1,y=!1,b=!1,p=null;function ie(){u=Array.from({length:P},()=>Array(f).fill(0))}function le(){ie(),L=0,F=0,B=1,l=null,m=null,y=!1,b=!1,p&&clearInterval(p),p=null}function A(e){l=e}function de(e){m=e}function Oe(e){L=e}function He(e){F=e}function Ue(e){B=e}function Ge(e){y=e}function Fe(e){b=e}function Xe(e){p=e}function O(){const e=Math.floor(Math.random()*ee.length),n=ee[e],t=e+1,s=Math.floor(f/2)-Math.floor(n[0].length/2);return{shape:n,color:t,x:s,y:0}}function X(e){for(let n=0;n<e.shape.length;n++)for(let t=0;t<e.shape[n].length;t++)if(e.shape[n][t]!==0){const s=e.y+n,o=e.x+t;if(o<0||o>=f||s>=u.length||s>=0&&u[s][o]!==0)return!0}return!1}function Ye(e){e.shape.forEach((n,t)=>{n.forEach((s,o)=>{if(s!==0){const a=e.y+t,r=e.x+o;a>=0&&a<u.length&&r>=0&&r<f&&(u[a][r]=e.color)}})})}function qe(e){const n=e.shape,t=n.length,s=Array.from({length:t},()=>Array(t).fill(0));for(let o=0;o<t;o++)for(let a=0;a<t;a++)s[a][t-1-o]=n[o][a];return{...e,shape:s}}const S=document.getElementById("game-board"),$=document.getElementById("next-piece-display");function k(){S.innerHTML="",u.forEach((e,n)=>{e.forEach((t,s)=>{const o=document.createElement("div");o.classList.add("block"),t!==0?o.classList.add(G[t]):o.classList.add("bg-gray-900"),S.appendChild(o)})}),l&&ze(l)}function ze(e){e.shape.forEach((n,t)=>{n.forEach((s,o)=>{if(s!==0){const a=e.y+t,r=e.x+o;if(a>=0&&a<P&&r>=0&&r<f){const c=a*f+r,i=S.children[c];i&&(i.className="block",i.classList.add(G[e.color]))}}})})}function Y(){$.innerHTML="";for(let e=0;e<v*v;e++){const n=document.createElement("div");n.classList.add("block","w-1/4","h-1/4","border-gray-800"),$.appendChild(n)}if(m){const e=Math.floor((v-m.shape.length)/2),n=Math.floor((v-m.shape[0].length)/2);m.shape.forEach((t,s)=>{t.forEach((o,a)=>{if(o!==0){const r=e+s,c=n+a,i=r*v+c,x=$.children[i];x&&(x.className="block w-1/4 h-1/4 border-gray-800",x.classList.add(G[m.color]))}})})}}function Ve(e,n,t){const s=S.getBoundingClientRect(),o=t*4+2;for(let a=0;a<o;a++){const r=document.createElement("div");r.classList.add("score-particle");let c="";a===0?t===4?c="🎉 TETRIS!":t===3?c="🔥 TRIPLE!":t===2?c="✨ DOUBLE!":c=`+${e}`:a<o/2?c=`+${Math.floor(e/(o/2))}`:c="⭐",r.textContent=c;const i=Math.random()*s.width,x=n/P*s.height;r.style.left=`${i}px`,r.style.top=`${x}px`;const J=Math.random()*2*Math.PI,K=40+Math.random()*120,ge=Math.cos(J)*K,ye=Math.sin(J)*K-30;r.style.setProperty("--tx",`${ge}px`),r.style.setProperty("--ty",`${ye}px`),r.style.animationDelay=`${Math.random()*.1}s`,document.querySelector(".board-container").appendChild(r),setTimeout(()=>{r.remove()},1300+Math.random()*100)}}function je(e){e.forEach(n=>{for(let t=0;t<f;t++){const s=n*f+t,o=S.children[s];o&&(o.style.animation="flash 0.3s ease-in-out 2")}})}function q(e,n,t){const s=document.getElementById("score-display"),o=document.getElementById("level-display"),a=document.getElementById("speed-display");if(s.textContent=e,o.textContent=n,a)if(localStorage.getItem("showSpeed")==="true"){const c=Math.round(ce/n);a.textContent=`(${c}ms)`,a.classList.remove("hidden")}else a.classList.add("hidden")}function g(e,n){if(!l)return!1;const t={...l,x:l.x+e,y:l.y+n};return X(t)?!1:(A(t),k(),!0)}function ue(){if(!l)return;let e=0;for(;g(0,1);)e++;return e>0}function fe(){if(!l)return;const e=qe(l),n=[[0,0],[-1,0],[1,0],[0,-1],[0,1]];for(const[t,s]of n){const o={...e,x:e.x+t,y:e.y+s};if(!X(o)){A(o),k();return}}}function We(){let e=0;const n=[];for(let t=P-1;t>=0;t--)u[t].every(s=>s!==0)&&(n.push(t),e++);e>0&&(je(n),setTimeout(()=>{n.sort((c,i)=>c-i),n.forEach(()=>{for(let c=P-1;c>=0;c--)if(u[c].every(i=>i!==0)){u.splice(c,1),u.unshift(Array(f).fill(0));break}});const t=$e*e*e,s=L+t;Oe(s);const o=n[Math.floor(n.length/2)];Ve(t,o,e);const a=F+e;He(a);const r=Math.floor(a/Ne)+1;r>B&&(Ue(r),Qe()),k()},600))}function Je(){return A(m),de(O()),!X(l)}let E=null,H=null;function Ke(e,n){E=e,H=n}function Ze(e=!1){if(!y||b)return;if(!g(0,1)||e){if(Ye(window.currentPiece),We(),!Je()){H&&H();return}k(),Y()}}function z(){const e=ce/B;p&&clearInterval(p);const n=setInterval(()=>E&&E(),e);Xe(n)}function Qe(){y&&!b&&z()}function V(e){if(!y||b){if(e.key===" "||e.key==="Enter"){e.preventDefault();const n=document.getElementById("start-button"),t=document.getElementById("pause-button");n.classList.contains("hidden")?t.classList.contains("hidden")||t.click():n.click()}return}switch(e.key){case"ArrowLeft":e.preventDefault(),g(-1,0);break;case"ArrowRight":e.preventDefault(),g(1,0);break;case"ArrowDown":e.preventDefault(),g(0,1);break;case"ArrowUp":case"r":case"R":e.preventDefault(),fe();break;case" ":e.preventDefault(),ue()&&E&&E(!0);break;case"p":case"P":case"Escape":e.preventDefault(),document.getElementById("pause-button").click();break}}function he(e){var t;const n=(t=e.target.closest("button"))==null?void 0:t.dataset.action;if(!(!n||!y||b))switch(n){case"left":g(-1,0);break;case"right":g(1,0);break;case"down":g(0,1);break;case"rotate":fe();break;case"hard-drop":ue()&&E&&E(!0);break}}function et(){if(!y)return;const e=!b;Fe(e);const n=document.getElementById("status-message"),t=document.getElementById("pause-button");e?(p&&clearInterval(p),n.textContent="PAUSED",t.textContent="RESUME"):(z(),n.textContent="GAME ON!",t.textContent="PAUSE")}const D=document.getElementById("start-button"),j=document.getElementById("pause-button"),me=document.getElementById("touch-controls"),pe=document.getElementById("status-message"),te=document.getElementById("game-board"),tt=document.getElementById("settings-button"),M=document.getElementById("settings-modal"),nt=document.getElementById("settings-close-btn"),W=document.getElementById("show-speed-toggle");window.currentPiece=l;Ke(Ze,st);function ot(){if(y)return;le(),q(0,1);const e=O(),n=O();A(e),de(n),window.currentPiece=e,Y(),Ge(!0),pe.textContent="GAME ON!",D.classList.add("hidden"),j.classList.remove("hidden"),k(),z(),at()}function st(){le(),pe.textContent=`GAME OVER! Score: ${L}`,D.textContent="RESTART",D.classList.remove("hidden"),j.classList.add("hidden"),te.style.opacity="0.5",setTimeout(()=>{te.style.opacity="1"},100),Te(L),rt()}function at(){document.addEventListener("keydown",V),me.addEventListener("click",he)}function rt(){document.removeEventListener("keydown",V),me.removeEventListener("click",he)}function ct(){const e=localStorage.getItem("showSpeed")==="true";W.checked=e,M.classList.remove("hidden")}function ne(){M.classList.add("hidden")}function N(){const e=W.checked;localStorage.setItem("showSpeed",e.toString()),q(L,B)}async function it(){const{db:e,auth:n,userId:t,appId:s}=await Ae();e&&t&&(_e(s,e,t),Re()),D.addEventListener("click",ot),j.addEventListener("click",et),tt.addEventListener("click",()=>{ct()}),nt.addEventListener("click",()=>{N(),ne()}),W.addEventListener("change",()=>{N()}),M.addEventListener("click",o=>{o.target===M&&(N(),ne())}),ie(),k(),Y(),q(0,1),document.addEventListener("keydown",V)}it();
