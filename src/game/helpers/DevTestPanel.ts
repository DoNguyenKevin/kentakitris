// src/game/helpers/DevTestPanel.ts
// ======================================================
// ‚úÖ Dev Test Panel - B·∫£ng ƒëi·ªÅu khi·ªÉn test cho developer
// 
// Panel n√†y gi√∫p developer d·ªÖ d√†ng test c√°c ch·ª©c nƒÉng power-ups
// C√≥ th·ªÉ m·ªü/ƒë√≥ng b·∫±ng ph√≠m 'D' (Debug)
// 
// üéØ M·ª•c ƒë√≠ch: Kh√¥ng c·∫ßn nh·ªõ ph√≠m t·∫Øt, click chu·ªôt ƒë·ªÉ test!
// ======================================================

import { Scene } from 'phaser';
import { PowerUpManager } from '../managers/PowerUpManager';
import { PowerUpType, ALL_POWERUP_CONFIGS } from '../constants/PowerUpConstants';

/**
 * ‚úÖ DevTestPanel - B·∫£ng ƒëi·ªÅu khi·ªÉn test power-ups
 * 
 * M·ª•c ti√™u: T·∫°o UI ƒë·ªÉ dev test power-ups d·ªÖ d√†ng
 * 
 * C√°ch ho·∫°t ƒë·ªông:
 * 1. Hi·ªÉn th·ªã panel khi nh·∫•n ph√≠m 'D'
 * 2. Hi·ªÉn th·ªã 5 power-ups v·ªõi n√∫t k√≠ch ho·∫°t
 * 3. Cho ph√©p nh·∫≠p s·ªë uses v√† duration t√πy ch·ªânh
 * 4. C√≥ n√∫t Reset ƒë·ªÉ t·∫Øt t·∫•t c·∫£ power-ups
 * 
 * Try it: Nh·∫•n 'D' trong game ƒë·ªÉ m·ªü panel!
 */
export class DevTestPanel {
    private scene: Scene;
    private powerUpManager: PowerUpManager;
    private isVisible: boolean = false;
    
    // üé® UI Elements
    private container: Phaser.GameObjects.Container;
    private background: Phaser.GameObjects.Rectangle;
    private titleText: Phaser.GameObjects.Text;
    private closeButton: Phaser.GameObjects.Text;
    private buttons: Phaser.GameObjects.Text[] = [];
    
    // üìä Input fields (simulated with text)
    private usesInputs: Map<PowerUpType, number> = new Map();
    private durationInputs: Map<PowerUpType, number> = new Map();
    
    /**
     * ‚úÖ Constructor - Kh·ªüi t·∫°o DevTestPanel
     * 
     * @param scene - Phaser Scene
     * @param powerUpManager - PowerUpManager instance
     */
    constructor(scene: Scene, powerUpManager: PowerUpManager) {
        this.scene = scene;
        this.powerUpManager = powerUpManager;
        
        // Kh·ªüi t·∫°o gi√° tr·ªã m·∫∑c ƒë·ªãnh cho inputs
        ALL_POWERUP_CONFIGS.forEach(config => {
            this.usesInputs.set(config.type, config.defaultUses || 1);
            this.durationInputs.set(config.type, config.defaultDuration || 0);
        });
        
        this.createPanel();
        this.hide(); // ·∫®n ban ƒë·∫ßu
    }
    
    /**
     * ‚úÖ createPanel() - T·∫°o UI panel
     * 
     * T·∫°o panel v·ªõi:
     * - N·ªÅn t·ªëi c√≥ vi·ªÅn
     * - Ti√™u ƒë·ªÅ "Dev Test Panel"
     * - Danh s√°ch 5 power-ups
     * - M·ªói power-up c√≥: T√™n, n√∫t Activate, n√∫t +/-, n√∫t Reset
     * - N√∫t Close ·ªü g√≥c tr√™n
     */
    private createPanel(): void {
        // üì¶ Container ƒë·ªÉ nh√≥m t·∫•t c·∫£ UI
        this.container = this.scene.add.container(0, 0);
        this.container.setDepth(1000); // Hi·ªÉn th·ªã tr√™n t·∫•t c·∫£
        
        // üé® Background - N·ªÅn panel
        const panelWidth = 600;
        const panelHeight = 500;
        const panelX = 512; // Gi·ªØa m√†n h√¨nh (1024/2)
        const panelY = 384; // Gi·ªØa m√†n h√¨nh (768/2)
        
        this.background = this.scene.add.rectangle(
            panelX, panelY, 
            panelWidth, panelHeight,
            0x000000, 0.9
        );
        this.background.setStrokeStyle(3, 0x00FF88);
        this.container.add(this.background);
        
        // üìù Title
        this.titleText = this.scene.add.text(
            panelX, panelY - 220,
            'üß™ Dev Test Panel - Power-ups',
            {
                fontFamily: 'Arial Black',
                fontSize: '24px',
                color: '#00FF88',
                align: 'center'
            }
        ).setOrigin(0.5);
        this.container.add(this.titleText);
        
        // ‚ùå Close button
        this.closeButton = this.scene.add.text(
            panelX + 280, panelY - 230,
            '‚úï',
            {
                fontFamily: 'Arial',
                fontSize: '28px',
                color: '#FF4444',
                align: 'center'
            }
        ).setOrigin(0.5);
        this.closeButton.setInteractive({ useHandCursor: true });
        this.closeButton.on('pointerdown', () => this.hide());
        this.closeButton.on('pointerover', () => this.closeButton.setScale(1.2));
        this.closeButton.on('pointerout', () => this.closeButton.setScale(1.0));
        this.container.add(this.closeButton);
        
        // üìù Instruction text
        const instructionText = this.scene.add.text(
            panelX, panelY - 180,
            'Nh·∫•n "D" ƒë·ªÉ m·ªü/ƒë√≥ng | Click n√∫t ƒë·ªÉ k√≠ch ho·∫°t power-up',
            {
                fontFamily: 'Arial',
                fontSize: '14px',
                color: '#AAAAAA',
                align: 'center'
            }
        ).setOrigin(0.5);
        this.container.add(instructionText);
        
        // üéØ T·∫°o n√∫t cho m·ªói power-up
        const startY = panelY - 140;
        const rowHeight = 60;
        
        ALL_POWERUP_CONFIGS.forEach((config, index) => {
            const y = startY + index * rowHeight;
            this.createPowerUpRow(config, panelX, y);
        });
        
        // üîÑ Reset All button
        const resetAllButton = this.scene.add.text(
            panelX, panelY + 200,
            'üîÑ Reset All Power-ups',
            {
                fontFamily: 'Arial',
                fontSize: '18px',
                color: '#FFD700',
                backgroundColor: '#333333',
                padding: { x: 12, y: 8 }
            }
        ).setOrigin(0.5);
        resetAllButton.setInteractive({ useHandCursor: true });
        resetAllButton.on('pointerdown', () => this.resetAllPowerUps());
        resetAllButton.on('pointerover', () => resetAllButton.setScale(1.1));
        resetAllButton.on('pointerout', () => resetAllButton.setScale(1.0));
        this.container.add(resetAllButton);
    }
    
    /**
     * ‚úÖ createPowerUpRow() - T·∫°o m·ªôt h√†ng cho power-up
     * 
     * M·ªói h√†ng bao g·ªìm:
     * - Emoji + T√™n power-up
     * - N√∫t Activate
     * - Input uses/duration (n√∫t +/-)
     * 
     * @param config - C·∫•u h√¨nh power-up
     * @param centerX - T·ªça ƒë·ªô X gi·ªØa panel
     * @param y - T·ªça ƒë·ªô Y c·ªßa h√†ng
     */
    private createPowerUpRow(config: any, centerX: number, y: number): void {
        // üìù Power-up name
        const nameText = this.scene.add.text(
            centerX - 220, y,
            `${config.emoji} ${config.name}`,
            {
                fontFamily: 'Arial',
                fontSize: '16px',
                color: '#FFFFFF'
            }
        ).setOrigin(0, 0.5);
        this.container.add(nameText);
        
        // üéØ Activate button
        const activateButton = this.scene.add.text(
            centerX - 50, y,
            'Activate',
            {
                fontFamily: 'Arial',
                fontSize: '14px',
                color: '#FFFFFF',
                backgroundColor: '#444444',
                padding: { x: 8, y: 4 }
            }
        ).setOrigin(0.5);
        activateButton.setInteractive({ useHandCursor: true });
        activateButton.on('pointerdown', () => {
            const uses = this.usesInputs.get(config.type);
            const duration = this.durationInputs.get(config.type);
            this.powerUpManager.activatePowerUp(config.type, uses, duration);
        });
        activateButton.on('pointerover', () => {
            activateButton.setStyle({ backgroundColor: '#00FF88' });
        });
        activateButton.on('pointerout', () => {
            activateButton.setStyle({ backgroundColor: '#444444' });
        });
        this.container.add(activateButton);
        this.buttons.push(activateButton);
        
        // üî¢ Uses/Duration controls
        if (config.defaultUses !== undefined) {
            // Uses control
            this.createNumberControl(
                config.type,
                centerX + 60, y,
                'Uses:',
                this.usesInputs,
                1, 10
            );
        }
        
        if (config.defaultDuration !== undefined) {
            // Duration control (in seconds)
            this.createNumberControl(
                config.type,
                centerX + 150, y,
                'Sec:',
                this.durationInputs,
                1000, 60000,
                true // convert to seconds
            );
        }
    }
    
    /**
     * ‚úÖ createNumberControl() - T·∫°o control tƒÉng/gi·∫£m s·ªë
     * 
     * @param type - Power-up type
     * @param x - T·ªça ƒë·ªô X
     * @param y - T·ªça ƒë·ªô Y
     * @param label - Nh√£n (Uses/Sec)
     * @param valueMap - Map l∆∞u gi√° tr·ªã
     * @param step - B∆∞·ªõc tƒÉng/gi·∫£m
     * @param max - Gi√° tr·ªã t·ªëi ƒëa
     * @param inSeconds - Hi·ªÉn th·ªã d∆∞·ªõi d·∫°ng gi√¢y
     */
    private createNumberControl(
        type: PowerUpType,
        x: number,
        y: number,
        label: string,
        valueMap: Map<PowerUpType, number>,
        step: number,
        max: number,
        inSeconds: boolean = false
    ): void {
        // Label
        const labelText = this.scene.add.text(x - 30, y, label, {
            fontFamily: 'Arial',
            fontSize: '12px',
            color: '#AAAAAA'
        }).setOrigin(0, 0.5);
        this.container.add(labelText);
        
        // Value display
        const getValue = () => {
            const val = valueMap.get(type) || 0;
            return inSeconds ? Math.floor(val / 1000) : val;
        };
        
        const valueText = this.scene.add.text(x + 35, y, getValue().toString(), {
            fontFamily: 'Arial',
            fontSize: '14px',
            color: '#FFFFFF'
        }).setOrigin(0.5);
        this.container.add(valueText);
        
        // - button
        const minusButton = this.scene.add.text(x + 10, y, '-', {
            fontFamily: 'Arial',
            fontSize: '16px',
            color: '#FFFFFF',
            backgroundColor: '#333333',
            padding: { x: 6, y: 2 }
        }).setOrigin(0.5);
        minusButton.setInteractive({ useHandCursor: true });
        minusButton.on('pointerdown', () => {
            const current = valueMap.get(type) || 0;
            const newValue = Math.max(step, current - step);
            valueMap.set(type, newValue);
            valueText.setText(getValue().toString());
        });
        this.container.add(minusButton);
        
        // + button
        const plusButton = this.scene.add.text(x + 60, y, '+', {
            fontFamily: 'Arial',
            fontSize: '16px',
            color: '#FFFFFF',
            backgroundColor: '#333333',
            padding: { x: 6, y: 2 }
        }).setOrigin(0.5);
        plusButton.setInteractive({ useHandCursor: true });
        plusButton.on('pointerdown', () => {
            const current = valueMap.get(type) || 0;
            const newValue = Math.min(max, current + step);
            valueMap.set(type, newValue);
            valueText.setText(getValue().toString());
        });
        this.container.add(plusButton);
    }
    
    /**
     * ‚úÖ resetAllPowerUps() - Reset t·∫•t c·∫£ power-ups
     * 
     * T·∫Øt t·∫•t c·∫£ power-ups ƒëang active
     */
    private resetAllPowerUps(): void {
        ALL_POWERUP_CONFIGS.forEach(config => {
            this.powerUpManager.deactivatePowerUp(config.type);
        });
        console.log('üîÑ All power-ups reset!');
    }
    
    /**
     * ‚úÖ toggle() - B·∫≠t/t·∫Øt panel
     */
    toggle(): void {
        if (this.isVisible) {
            this.hide();
        } else {
            this.show();
        }
    }
    
    /**
     * ‚úÖ show() - Hi·ªÉn th·ªã panel
     */
    show(): void {
        this.isVisible = true;
        this.container.setVisible(true);
    }
    
    /**
     * ‚úÖ hide() - ·∫®n panel
     */
    hide(): void {
        this.isVisible = false;
        this.container.setVisible(false);
    }
    
    /**
     * ‚úÖ destroy() - D·ªçn d·∫πp khi scene k·∫øt th√∫c
     */
    destroy(): void {
        this.container.destroy();
    }
}
